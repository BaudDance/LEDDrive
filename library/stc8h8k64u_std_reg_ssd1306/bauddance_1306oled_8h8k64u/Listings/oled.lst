C51 COMPILER V9.60.7.0   OLED                                                              12/11/2023 21:20:52 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE OLED
OBJECT MODULE PLACED IN .\Objects\oled.obj
COMPILER INVOKED BY: D:\ProgramFiles\Keil_v5\C51\BIN\C51.EXE oled.c LARGE OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PR
                    -INT(.\Listings\oled.lst) TABS(2) OBJECT(.\Objects\oled.obj)

line level    source

   1          /**
   2           * @file oled.c
   3           * @brief æ³¢ç‰¹å¾‹åŠ¨OLEDé©±åŠ¨(SSD1306)
   4           * @anchor æ³¢ç‰¹å¾‹åŠ¨(keysking åšå“¥åœ¨å­¦ä¹ )
   5           * @version 1.0
   6           * @date 2023-08-19
   7           * @license MIT License
   8           *
   9           * @attention
  10           * æœ¬é©±åŠ¨åº“é’ˆå¯¹æ³¢ç‰¹å¾‹åŠ¨Â·keyskingçš„STM32æ•™ç¨‹å­¦ä¹ å¥—ä»¶è¿›è¡Œå¼€å‘
  11           * åœ¨å…¶ä»–å¹³å°æˆ–é©±åŠ¨èŠ¯ç‰‡ä¸Šä½¿ç”¨å¯èƒ½éœ€è¦è¿›è¡Œç§»æ¤
  12           *
  13           * @note
  14           * ä½¿ç”¨æµç¨‹:
  15           * 1. STM32åˆå§‹åŒ–IICå®Œæˆåè°ƒç”¨OLED_Init()åˆå§‹åŒ–OLED. æ³¨æ„STM32å¯åŠ¨æ¯”OLEDä¸Šç”µå¿«, å¯ç­‰å
             -¾…20mså†åˆå§‹åŒ–OLED
  16           * 2. è°ƒç”¨OLED_NewFrame()å¼€å§‹ç»˜åˆ¶æ–°çš„ä¸€å¸§
  17           * 3. è°ƒç”¨OLED_DrawXXX()ç³»åˆ—å‡½æ•°ç»˜åˆ¶å›¾å½¢åˆ°æ˜¾å­˜ è°ƒç”¨OLED_Printxxx()ç³»åˆ—å‡½æ•°ç»˜åˆ¶æ–‡æœ¬å
             -ˆ°æ˜¾å­˜
  18           * 4. è°ƒç”¨OLED_ShowFrame()å°†æ˜¾å­˜å†…å®¹æ˜¾ç¤ºåˆ°OLED
  19           *
  20           * @note
  21           * ä¸ºä¿è¯ä¸­æ–‡æ˜¾ç¤ºæ­£å¸¸ è¯·å°†ç¼–è¯‘å™¨çš„å­—ç¬¦é›†è®¾ç½®ä¸ºUTF-8
  22           *
  23           */
  24          /*8051 Version
  25           *STC15,STC8 With HW IIC
  26           *Note:è¯·å‹¿éšæ„æ”¹å˜å‡½æ•°ã€å˜é‡å®šä¹‰/å£°æ˜çš„ä½ç½®
  27           *Note:ç»“æ„ä½“å˜é‡å®šä¹‰/å£°æ˜æ—¶éœ€è¦structå…³é”®å­—ï¼ˆå¯èƒ½æ˜¯ç¼–è¯‘å™¨çš„BUGï¼‰
  28           *Note:codeå…³é”®å­—ç”¨äºç¡®ä¿å¸¸é‡ä½äºflashä¸­ï¼Œè¯·å‹¿åˆ é™¤
  29           *Note:ç¼–è¯‘é€‰é¡¹Memory Modelé€‰æ‹©Large:variables in XDATA
  30           *2023/12/11 FQL
  31          */
  32          #include "oled.h"
  33          #include <math.h>
  34          #include <stdlib.h>
  35          #include "STC8G_H_I2C.h"
  36          
  37          // OLEDå™¨ä»¶åœ°å€
  38          #define OLED_ADDRESS 0x78
  39          
  40          // OLEDå‚æ•°
  41          #define OLED_PAGE 8            // OLEDé¡µæ•°
  42          #define OLED_ROW 8 * OLED_PAGE // OLEDè¡Œæ•°
  43          #define OLED_COLUMN 128        // OLEDåˆ—æ•°
  44          
  45          // æ˜¾å­˜
  46          uint8_t xdata OLED_GRAM[OLED_PAGE][OLED_COLUMN];
  47          
  48          // ========================== åº•å±‚é€šä¿¡å‡½æ•° ==========================
  49          
  50          /**
  51           * @brief å‘OLEDå‘é€æ•°æ®çš„å‡½æ•°
  52           * @param data_8 è¦å‘é€çš„æ•°æ®
C51 COMPILER V9.60.7.0   OLED                                                              12/11/2023 21:20:52 PAGE 2   

  53           * @param len è¦å‘é€çš„æ•°æ®é•¿åº¦
  54           * @return None
  55           * @note æ­¤å‡½æ•°æ˜¯ç§»æ¤æœ¬é©±åŠ¨æ—¶çš„é‡è¦å‡½æ•° å°†æœ¬é©±åŠ¨åº“ç§»æ¤åˆ°å…¶ä»–å¹³å°æ—¶åº”æ ¹æ®å®
             -é™…æƒ…å†µä¿®æ”¹æ­¤å‡½æ•°
  56           */
  57          void OLED_Send(uint8_t *data_8, uint8_t len)
  58          {
  59   1        I2C_WriteNbyte_WithoutmemaddrWrite(OLED_ADDRESS, data_8, len);
  60   1      //  HAL_I2C_Master_Transmit(&hi2c2, OLED_ADDRESS, data_8, len,HAL_MAX_DELAY);
  61   1      //  HAL_I2C_Master_Transmit_IT(&hi2c2, OLED_ADDRESS, data_8, len);
  62   1      //  HAL_I2C_Master_Transmit_DMA(&hi2c2, OLED_ADDRESS, data_8, len);
  63   1      }
  64          
  65          /**
  66           * @brief å‘OLEDå‘é€æŒ‡ä»¤
  67           */
  68          void OLED_SendCmd(uint8_t cmd)
  69          {
  70   1        static uint8_t sendBuffer[2] = {0};
  71   1        sendBuffer[1] = cmd;
  72   1        OLED_Send(sendBuffer, 2);
  73   1      }
  74          
  75          // ========================== OLEDé©±åŠ¨å‡½æ•° ==========================
  76          
  77          /**
  78           * @brief åˆå§‹åŒ–OLED (SSD1306)
  79           * @note æ­¤å‡½æ•°æ˜¯ç§»æ¤æœ¬é©±åŠ¨æ—¶çš„é‡è¦å‡½æ•° å°†æœ¬é©±åŠ¨åº“ç§»æ¤åˆ°å…¶ä»–é©±åŠ¨èŠ¯ç‰‡æ—¶åº”æ ¹
             -æ®å®é™…æƒ…å†µä¿®æ”¹æ­¤å‡½æ•°
  80           */
  81          void OLED_Init()
  82          {
  83   1        OLED_SendCmd(0xAE); /*å…³é—­æ˜¾ç¤º display off*/
  84   1      
  85   1        OLED_SendCmd(0x20);
  86   1        OLED_SendCmd(0x10);
  87   1      
  88   1        OLED_SendCmd(0xB0);
  89   1      
  90   1        OLED_SendCmd(0xC8);
  91   1      
  92   1        OLED_SendCmd(0x00);
  93   1        OLED_SendCmd(0x10);
  94   1      
  95   1        OLED_SendCmd(0x40);
  96   1      
  97   1        OLED_SendCmd(0x81);
  98   1      
  99   1        OLED_SendCmd(0xDF);
 100   1        OLED_SendCmd(0xA1);
 101   1      
 102   1        OLED_SendCmd(0xA6);
 103   1        OLED_SendCmd(0xA8);
 104   1      
 105   1        OLED_SendCmd(0x3F);
 106   1      
 107   1        OLED_SendCmd(0xA4);
 108   1      
 109   1        OLED_SendCmd(0xD3);
 110   1        OLED_SendCmd(0x00);
 111   1      
 112   1        OLED_SendCmd(0xD5);
C51 COMPILER V9.60.7.0   OLED                                                              12/11/2023 21:20:52 PAGE 3   

 113   1        OLED_SendCmd(0xF0);
 114   1      
 115   1        OLED_SendCmd(0xD9);
 116   1        OLED_SendCmd(0x22);
 117   1      
 118   1        OLED_SendCmd(0xDA);
 119   1        OLED_SendCmd(0x12);
 120   1      
 121   1        OLED_SendCmd(0xDB);
 122   1        OLED_SendCmd(0x20);
 123   1      
 124   1        OLED_SendCmd(0x8D);
 125   1        OLED_SendCmd(0x14);
 126   1      //  OLED_SendCmd(0xAE); //å…³é—­æ˜¾ç¤º
 127   1      //  
 128   1      //  OLED_SendCmd(0xD5); //è®¾ç½®æ˜¾ç¤ºæ—¶é’Ÿåˆ†é¢‘æ¯”/æŒ¯è¡å™¨é¢‘ç‡
 129   1      //  OLED_SendCmd(0x80);
 130   1      //  
 131   1      //  OLED_SendCmd(0xA8); //è®¾ç½®å¤šè·¯å¤ç”¨ç‡
 132   1      //  OLED_SendCmd(0x3F);
 133   1      //  
 134   1      //  OLED_SendCmd(0xD3); //è®¾ç½®æ˜¾ç¤ºåç§»
 135   1      //  OLED_SendCmd(0x00);
 136   1      //  
 137   1      //  OLED_SendCmd(0x40); //è®¾ç½®æ˜¾ç¤ºå¼€å§‹è¡Œ
 138   1      //  
 139   1      //  OLED_SendCmd(0xA1); //è®¾ç½®å·¦å³æ–¹å‘ï¼Œ0xA1æ­£å¸¸ 0xA0å·¦å³åç½®
 140   1      //  
 141   1      //  OLED_SendCmd(0xC8); //è®¾ç½®ä¸Šä¸‹æ–¹å‘ï¼Œ0xC8æ­£å¸¸ 0xC0ä¸Šä¸‹åç½®
 142   1      
 143   1      //  OLED_SendCmd(0xDA); //è®¾ç½®COMå¼•è„šç¡¬ä»¶é…ç½®
 144   1      //  OLED_SendCmd(0x12);
 145   1      //  
 146   1      //  OLED_SendCmd(0x81); //è®¾ç½®å¯¹æ¯”åº¦æ§åˆ¶
 147   1      //  OLED_SendCmd(0xCF);
 148   1      
 149   1      //  OLED_SendCmd(0xD9); //è®¾ç½®é¢„å……ç”µå‘¨æœŸ
 150   1      //  OLED_SendCmd(0xF1);
 151   1      
 152   1      //  OLED_SendCmd(0xDB); //è®¾ç½®VCOMHå–æ¶ˆé€‰æ‹©çº§åˆ«
 153   1      //  OLED_SendCmd(0x30);
 154   1      
 155   1      //  OLED_SendCmd(0xA4); //è®¾ç½®æ•´ä¸ªæ˜¾ç¤ºæ‰“å¼€/å…³é—­
 156   1      
 157   1      //  OLED_SendCmd(0xA6); //è®¾ç½®æ­£å¸¸/å€’è½¬æ˜¾ç¤º
 158   1      
 159   1      //  OLED_SendCmd(0x8D); //è®¾ç½®å……ç”µæ³µ
 160   1      //  OLED_SendCmd(0x14);
 161   1      
 162   1      
 163   1        OLED_NewFrame();
 164   1        OLED_ShowFrame();
 165   1      
 166   1        OLED_SendCmd(0xAF); /*å¼€å¯æ˜¾ç¤º display ON*/
 167   1        
 168   1      //  OLED_NewFrame();
 169   1      //  OLED_ShowFrame();
 170   1      }
 171          
 172          /**
 173           * @brief å¼€å¯OLEDæ˜¾ç¤º
 174           */
C51 COMPILER V9.60.7.0   OLED                                                              12/11/2023 21:20:52 PAGE 4   

 175          void OLED_DisPlay_On()
 176          {
 177   1        OLED_SendCmd(0x8D); // ç”µè·æ³µä½¿èƒ½
 178   1        OLED_SendCmd(0x14); // å¼€å¯ç”µè·æ³µ
 179   1        OLED_SendCmd(0xAF); // ç‚¹äº®å±å¹•
 180   1      }
 181          
 182          /**
 183           * @brief å…³é—­OLEDæ˜¾ç¤º
 184           */
 185          void OLED_DisPlay_Off()
 186          {
 187   1        OLED_SendCmd(0x8D); // ç”µè·æ³µä½¿èƒ½
 188   1        OLED_SendCmd(0x10); // å…³é—­ç”µè·æ³µ
 189   1        OLED_SendCmd(0xAE); // å…³é—­å±å¹•
 190   1      }
 191          
 192          /**
 193           * @brief è®¾ç½®é¢œè‰²æ¨¡å¼ é»‘åº•ç™½å­—æˆ–ç™½åº•é»‘å­—
 194           * @param ColorMode é¢œè‰²æ¨¡å¼COLOR_NORMAL/COLOR_REVERSED
 195           * @note æ­¤å‡½æ•°ç›´æ¥è®¾ç½®å±å¹•çš„é¢œè‰²æ¨¡å¼
 196           */
 197          void OLED_SetColorMode(OLED_ColorMode mode)
 198          {
 199   1        if (mode == OLED_COLOR_NORMAL)
 200   1        {
 201   2          OLED_SendCmd(0xA6); // æ­£å¸¸æ˜¾ç¤º
 202   2        }
 203   1        if (mode == OLED_COLOR_REVERSED)
 204   1        {
 205   2          OLED_SendCmd(0xA7); // åè‰²æ˜¾ç¤º
 206   2        }
 207   1      }
 208          
 209          // ========================== æ˜¾å­˜æ“ä½œå‡½æ•° ==========================
 210          
 211          /**
 212           * @brief æ¸…ç©ºæ˜¾å­˜ ç»˜åˆ¶æ–°çš„ä¸€å¸§
 213           */
 214          void OLED_NewFrame()
 215          {
 216   1        memset(OLED_GRAM, 0, sizeof(OLED_GRAM));
 217   1      }
 218          
 219          /**
 220           * @brief å°†å½“å‰æ˜¾å­˜æ˜¾ç¤ºåˆ°å±å¹•ä¸Š
 221           * @note æ­¤å‡½æ•°æ˜¯ç§»æ¤æœ¬é©±åŠ¨æ—¶çš„é‡è¦å‡½æ•° å°†æœ¬é©±åŠ¨åº“ç§»æ¤åˆ°å…¶ä»–é©±åŠ¨èŠ¯ç‰‡æ—¶åº”æ ¹
             -æ®å®é™…æƒ…å†µä¿®æ”¹æ­¤å‡½æ•°
 222           */
 223          void OLED_ShowFrame()
 224          {
 225   1        static xdata uint8_t sendBuffer[OLED_COLUMN + 1];
 226   1        uint8_t i;
 227   1        sendBuffer[0] = 0x40;
 228   1        for (i = 0; i < OLED_PAGE; i++)
 229   1        {
 230   2          OLED_SendCmd(0xB0 + i); // è®¾ç½®é¡µåœ°å€
 231   2          OLED_SendCmd(0x00);     // è®¾ç½®åˆ—åœ°å€ä½4ä½
 232   2          OLED_SendCmd(0x10);     // è®¾ç½®åˆ—åœ°å€é«˜4ä½
 233   2          memcpy(sendBuffer + 1, OLED_GRAM[i], OLED_COLUMN);
 234   2          OLED_Send(sendBuffer, OLED_COLUMN + 1);
 235   2        }
C51 COMPILER V9.60.7.0   OLED                                                              12/11/2023 21:20:52 PAGE 5   

 236   1      }
 237          
 238          /**
 239           * @brief è®¾ç½®ä¸€ä¸ªåƒç´ ç‚¹
 240           * @param x æ¨ªåæ ‡
 241           * @param y çºµåæ ‡
 242           * @param color é¢œè‰²
 243           */
 244          void OLED_SetPixel(uint8_t x, uint8_t y, OLED_ColorMode color)
 245          {
 246   1        if (x >= OLED_COLUMN || y >= OLED_ROW)
 247   1          return;
 248   1        if (!color)
 249   1        {
 250   2          OLED_GRAM[y / 8][x] |= 1 << (y % 8);
 251   2        }
 252   1        else
 253   1        {
 254   2          OLED_GRAM[y / 8][x] &= ~(1 << (y % 8));
 255   2        }
 256   1      }
 257          
 258          /**
 259           * @brief è®¾ç½®æ˜¾å­˜ä¸­ä¸€å­—èŠ‚æ•°æ®çš„æŸå‡ ä½
 260           * @param page é¡µåœ°å€
 261           * @param column åˆ—åœ°å€
 262           * @param data_8 æ•°æ®
 263           * @param start èµ·å§‹ä½
 264           * @param end ç»“æŸä½
 265           * @param color é¢œè‰²
 266           * @note æ­¤å‡½æ•°å°†æ˜¾å­˜ä¸­çš„æŸä¸€å­—èŠ‚çš„ç¬¬startä½åˆ°ç¬¬endä½è®¾ç½®ä¸ºä¸dataç›¸åŒ
 267           * @note startå’Œendçš„èŒƒå›´ä¸º0-7, startå¿…é¡»å°äºç­‰äºend
 268           * @note æ­¤å‡½æ•°ä¸OLED_SetByte_Fineçš„åŒºåˆ«åœ¨äºæ­¤å‡½æ•°åªèƒ½è®¾ç½®æ˜¾å­˜ä¸­çš„æŸä¸€çœŸå®å­—èŠ‚
 269           */
 270          void OLED_SetByte_Fine(uint8_t page, uint8_t column, uint8_t data_8, uint8_t start, uint8_t end, OLED_Colo
             -rMode color)
 271          {
 272   1        static uint8_t temp;
 273   1        if (page >= OLED_PAGE || column >= OLED_COLUMN)
 274   1          return;
 275   1        if (color)
 276   1          data_8 = ~data_8;
 277   1      
 278   1        temp = data_8 | (0xff << (end + 1)) | (0xff >> (8 - start));
 279   1        OLED_GRAM[page][column] &= temp;
 280   1        temp = data_8 & ~(0xff << (end + 1)) & ~(0xff >> (8 - start));
 281   1        OLED_GRAM[page][column] |= temp;
 282   1        // ä½¿ç”¨OLED_SetPixelå®ç°
 283   1        // for (uint8_t i = start; i <= end; i++) {
 284   1        //   OLED_SetPixel(column, page * 8 + i, !((data_8 >> i) & 0x01));
 285   1        // }
 286   1      }
 287          
 288          /**
 289           * @brief è®¾ç½®æ˜¾å­˜ä¸­çš„ä¸€å­—èŠ‚æ•°æ®
 290           * @param page é¡µåœ°å€
 291           * @param column åˆ—åœ°å€
 292           * @param data_8 æ•°æ®
 293           * @param color é¢œè‰²
 294           * @note æ­¤å‡½æ•°å°†æ˜¾å­˜ä¸­çš„æŸä¸€å­—èŠ‚è®¾ç½®ä¸ºdata_8çš„å€¼
 295           */
 296          void OLED_SetByte(uint8_t page, uint8_t column, uint8_t data_8, OLED_ColorMode color)
C51 COMPILER V9.60.7.0   OLED                                                              12/11/2023 21:20:52 PAGE 6   

 297          {
 298   1        if (page >= OLED_PAGE || column >= OLED_COLUMN)
 299   1          return;
 300   1        if (color)
 301   1          data_8 = ~data_8;
 302   1        OLED_GRAM[page][column] = data_8;
 303   1      }
 304          
 305          /**
 306           * @brief è®¾ç½®æ˜¾å­˜ä¸­çš„ä¸€å­—èŠ‚æ•°æ®çš„æŸå‡ ä½
 307           * @param x æ¨ªåæ ‡
 308           * @param y çºµåæ ‡
 309           * @param data_8 æ•°æ®
 310           * @param len ä½æ•°
 311           * @param color é¢œè‰²
 312           * @note æ­¤å‡½æ•°å°†æ˜¾å­˜ä¸­ä»(x,y)å¼€å§‹å‘ä¸‹æ•°lenä½è®¾ç½®ä¸ºä¸data_8ç›¸åŒ
 313           * @note lençš„èŒƒå›´ä¸º1-8
 314           * @note æ­¤å‡½æ•°ä¸OLED_SetByte_Fineçš„åŒºåˆ«åœ¨äºæ­¤å‡½æ•°çš„æ¨ªåæ ‡å’Œçºµåæ ‡æ˜¯ä»¥åƒç´ ä¸ºå•ä½
             -çš„, å¯èƒ½å‡ºç°è·¨ä¸¤ä¸ªçœŸå®å­—èŠ‚çš„æƒ…å†µ(è·¨é¡µ)
 315           */
 316          void OLED_SetBits_Fine(uint8_t x, uint8_t y, uint8_t data_8, uint8_t len, OLED_ColorMode color)
 317          {
 318   1        uint8_t page = y / 8;
 319   1        uint8_t bit_8 = y % 8;
 320   1        if (bit_8 + len > 8)
 321   1        {
 322   2          OLED_SetByte_Fine(page, x, data_8 << bit_8, bit_8, 7, color);
 323   2          OLED_SetByte_Fine(page + 1, x, data_8 >> (8 - bit_8), 0, len + bit_8 - 1 - 8, color);
 324   2        }
 325   1        else
 326   1        {
 327   2          OLED_SetByte_Fine(page, x, data_8 << bit_8, bit_8, bit_8 + len - 1, color);
 328   2        }
 329   1        // ä½¿ç”¨OLED_SetPixelå®ç°
 330   1        // for (uint8_t i = 0; i < len; i++) {
 331   1        //   OLED_SetPixel(x, y + i, !((data_8 >> i) & 0x01));
 332   1        // }
 333   1      }
 334          
 335          /**
 336           * @brief è®¾ç½®æ˜¾å­˜ä¸­ä¸€å­—èŠ‚é•¿åº¦çš„æ•°æ®
 337           * @param x æ¨ªåæ ‡
 338           * @param y çºµåæ ‡
 339           * @param data_8 æ•°æ®
 340           * @param color é¢œè‰²
 341           * @note æ­¤å‡½æ•°å°†æ˜¾å­˜ä¸­ä»(x,y)å¼€å§‹å‘ä¸‹æ•°8ä½è®¾ç½®ä¸ºä¸data_8ç›¸åŒ
 342           * @note æ­¤å‡½æ•°ä¸OLED_SetByteçš„åŒºåˆ«åœ¨äºæ­¤å‡½æ•°çš„æ¨ªåæ ‡å’Œçºµåæ ‡æ˜¯ä»¥åƒç´ ä¸ºå•ä½çš„,
             - å¯èƒ½å‡ºç°è·¨ä¸¤ä¸ªçœŸå®å­—èŠ‚çš„æƒ…å†µ(è·¨é¡µ)
 343           */
 344          void OLED_SetBits(uint8_t x, uint8_t y, uint8_t data_8, OLED_ColorMode color)
 345          {
 346   1        uint8_t page = y / 8;
 347   1        uint8_t bit_8 = y % 8;
 348   1        OLED_SetByte_Fine(page, x, data_8 << bit_8, bit_8, 7, color);
 349   1        if (bit_8)
 350   1        {
 351   2          OLED_SetByte_Fine(page + 1, x, data_8 >> (8 - bit_8), 0, bit_8 - 1, color);
 352   2        }
 353   1      }
 354          
 355          /**
 356           * @brief è®¾ç½®ä¸€å—æ˜¾å­˜åŒºåŸŸ
C51 COMPILER V9.60.7.0   OLED                                                              12/11/2023 21:20:52 PAGE 7   

 357           * @param x èµ·å§‹æ¨ªåæ ‡
 358           * @param y èµ·å§‹çºµåæ ‡
 359           * @param data_8 æ•°æ®çš„èµ·å§‹åœ°å€
 360           * @param w å®½åº¦
 361           * @param h é«˜åº¦
 362           * @param color é¢œè‰²
 363           * @note æ­¤å‡½æ•°å°†æ˜¾å­˜ä¸­ä»(x,y)å¼€å§‹çš„w*hä¸ªåƒç´ è®¾ç½®ä¸ºdata_8ä¸­çš„æ•°æ®
 364           * @note data_8çš„æ•°æ®åº”è¯¥é‡‡ç”¨åˆ—è¡Œå¼æ’åˆ—
 365           */
 366          void OLED_SetBlock(uint8_t x, uint8_t y, const uint8_t *data_8, uint8_t w, uint8_t h, OLED_ColorMode color
             -)
 367          {
 368   1        uint8_t fullRow = h / 8; // å®Œæ•´çš„è¡Œæ•°
 369   1        uint8_t partBit = h % 8; // ä¸å®Œæ•´çš„å­—èŠ‚ä¸­çš„æœ‰æ•ˆä½æ•°
 370   1        uint8_t i,j;
 371   1        uint16_t fullNum;
 372   1        
 373   1        for (i = 0; i < w; i++)
 374   1        {
 375   2          for (j = 0; j < fullRow; j++)
 376   2          {
 377   3            OLED_SetBits(x + i, y + j * 8, data_8[i + j * w], color);
 378   3          }
 379   2        }
 380   1        if (partBit)
 381   1        {
 382   2          fullNum = w * fullRow; // å®Œæ•´çš„å­—èŠ‚æ•°
 383   2          for (i = 0; i < w; i++)
 384   2          {
 385   3            OLED_SetBits_Fine(x + i, y + (fullRow * 8), data_8[fullNum + i], partBit, color);
 386   3          }
 387   2        }
 388   1        // ä½¿ç”¨OLED_SetPixelå®ç°
 389   1        // for (uint8_t i = 0; i < w; i++) {
 390   1        //   for (uint8_t j = 0; j < h; j++) {
 391   1        //     for (uint8_t k = 0; k < 8; k++) {
 392   1        //       if (j * 8 + k >= h) break; // é˜²æ­¢è¶Šç•Œ(ä¸å®Œæ•´çš„å­—èŠ‚
 393   1        //       OLED_SetPixel(x + i, y + j * 8 + k, !((data_8[i + j * w] >> k) & 0x01));
 394   1        //     }
 395   1        //   }
 396   1        // }
 397   1      }
 398          
 399          // ========================== å›¾å½¢ç»˜åˆ¶å‡½æ•° ==========================
 400          /**
 401           * @brief ç»˜åˆ¶ä¸€æ¡çº¿æ®µ
 402           * @param x1 èµ·å§‹ç‚¹æ¨ªåæ ‡
 403           * @param y1 èµ·å§‹ç‚¹çºµåæ ‡
 404           * @param x2 ç»ˆæ­¢ç‚¹æ¨ªåæ ‡
 405           * @param y2 ç»ˆæ­¢ç‚¹çºµåæ ‡
 406           * @param color é¢œè‰²
 407           * @note æ­¤å‡½æ•°ä½¿ç”¨Bresenhamç®—æ³•ç»˜åˆ¶çº¿æ®µ
 408           */
 409          void OLED_DrawLine(uint8_t x1, uint8_t y1, uint8_t x2, uint8_t y2, OLED_ColorMode color)
 410          {
 411   1        static uint8_t temp = 0;
 412   1        uint8_t x_8,y_8;
 413   1        int16_t dx;
 414   1        int16_t dy;
 415   1        int16_t ux;
 416   1        int16_t uy;
 417   1        int16_t x, y, eps;
C51 COMPILER V9.60.7.0   OLED                                                              12/11/2023 21:20:52 PAGE 8   

 418   1        
 419   1        if (x1 == x2)
 420   1        {
 421   2          if (y1 > y2)
 422   2          {
 423   3            temp = y1;
 424   3            y1 = y2;
 425   3            y2 = temp;
 426   3          }
 427   2          for (y_8 = y1; y_8 <= y2; y_8++)
 428   2          {
 429   3            OLED_SetPixel(x1, y_8, color);
 430   3          }
 431   2        }
 432   1        else if (y1 == y2)
 433   1        {
 434   2          if (x1 > x2)
 435   2          {
 436   3            temp = x1;
 437   3            x1 = x2;
 438   3            x2 = temp;
 439   3          }
 440   2          for (x_8 = x1; x_8 <= x2; x_8++)
 441   2          {
 442   3            OLED_SetPixel(x_8, y1, color);
 443   3          }
 444   2        }
 445   1        else
 446   1        {
 447   2          // Bresenhamç›´çº¿ç®—æ³•
 448   2          dx = x2 - x1;
 449   2          dy = y2 - y1;
 450   2          ux = ((dx > 0) << 1) - 1;
 451   2          uy = ((dy > 0) << 1) - 1;
 452   2          x = x1;
 453   2          y = y1;
 454   2          eps = 0;
 455   2          dx = abs(dx);
 456   2          dy = abs(dy);
 457   2          if (dx > dy)
 458   2          {
 459   3            for (x = x1; x != x2; x += ux)
 460   3            {
 461   4              OLED_SetPixel(x, y, color);
 462   4              eps += dy;
 463   4              if ((eps << 1) >= dx)
 464   4              {
 465   5                y += uy;
 466   5                eps -= dx;
 467   5              }
 468   4            }
 469   3          }
 470   2          else
 471   2          {
 472   3            for (y = y1; y != y2; y += uy)
 473   3            {
 474   4              OLED_SetPixel(x, y, color);
 475   4              eps += dx;
 476   4              if ((eps << 1) >= dy)
 477   4              {
 478   5                x += ux;
 479   5                eps -= dy;
C51 COMPILER V9.60.7.0   OLED                                                              12/11/2023 21:20:52 PAGE 9   

 480   5              }
 481   4            }
 482   3          }
 483   2        }
 484   1      }
 485          
 486          /**
 487           * @brief ç»˜åˆ¶ä¸€ä¸ªçŸ©å½¢
 488           * @param x èµ·å§‹ç‚¹æ¨ªåæ ‡
 489           * @param y èµ·å§‹ç‚¹çºµåæ ‡
 490           * @param w çŸ©å½¢å®½åº¦
 491           * @param h çŸ©å½¢é«˜åº¦
 492           * @param color é¢œè‰²
 493           */
 494          void OLED_DrawRectangle(uint8_t x, uint8_t y, uint8_t w, uint8_t h, OLED_ColorMode color)
 495          {
 496   1        OLED_DrawLine(x, y, x + w, y, color);
 497   1        OLED_DrawLine(x, y + h, x + w, y + h, color);
 498   1        OLED_DrawLine(x, y, x, y + h, color);
 499   1        OLED_DrawLine(x + w, y, x + w, y + h, color);
 500   1      }
 501          
 502          /**
 503           * @brief ç»˜åˆ¶ä¸€ä¸ªå¡«å……çŸ©å½¢
 504           * @param x èµ·å§‹ç‚¹æ¨ªåæ ‡
 505           * @param y èµ·å§‹ç‚¹çºµåæ ‡
 506           * @param w çŸ©å½¢å®½åº¦
 507           * @param h çŸ©å½¢é«˜åº¦
 508           * @param color é¢œè‰²
 509           */
 510          void OLED_DrawFilledRectangle(uint8_t x, uint8_t y, uint8_t w, uint8_t h, OLED_ColorMode color)
 511          {
 512   1        uint8_t i;
 513   1        for (i = 0; i < h; i++)
 514   1        {
 515   2          OLED_DrawLine(x, y + i, x + w, y + i, color);
 516   2        }
 517   1      }
 518          
 519          /**
 520           * @brief ç»˜åˆ¶ä¸€ä¸ªä¸‰è§’å½¢
 521           * @param x1 ç¬¬ä¸€ä¸ªç‚¹æ¨ªåæ ‡
 522           * @param y1 ç¬¬ä¸€ä¸ªç‚¹çºµåæ ‡
 523           * @param x2 ç¬¬äºŒä¸ªç‚¹æ¨ªåæ ‡
 524           * @param y2 ç¬¬äºŒä¸ªç‚¹çºµåæ ‡
 525           * @param x3 ç¬¬ä¸‰ä¸ªç‚¹æ¨ªåæ ‡
 526           * @param y3 ç¬¬ä¸‰ä¸ªç‚¹çºµåæ ‡
 527           * @param color é¢œè‰²
 528           */
 529          void OLED_DrawTriangle(uint8_t x1, uint8_t y1, uint8_t x2, uint8_t y2, uint8_t x3, uint8_t y3, OLED_ColorM
             -ode color)
 530          {
 531   1        OLED_DrawLine(x1, y1, x2, y2, color);
 532   1        OLED_DrawLine(x2, y2, x3, y3, color);
 533   1        OLED_DrawLine(x3, y3, x1, y1, color);
 534   1      }
 535          
 536          /**
 537           * @brief ç»˜åˆ¶ä¸€ä¸ªå¡«å……ä¸‰è§’å½¢
 538           * @param x1 ç¬¬ä¸€ä¸ªç‚¹æ¨ªåæ ‡
 539           * @param y1 ç¬¬ä¸€ä¸ªç‚¹çºµåæ ‡
 540           * @param x2 ç¬¬äºŒä¸ªç‚¹æ¨ªåæ ‡
C51 COMPILER V9.60.7.0   OLED                                                              12/11/2023 21:20:52 PAGE 10  

 541           * @param y2 ç¬¬äºŒä¸ªç‚¹çºµåæ ‡
 542           * @param x3 ç¬¬ä¸‰ä¸ªç‚¹æ¨ªåæ ‡
 543           * @param y3 ç¬¬ä¸‰ä¸ªç‚¹çºµåæ ‡
 544           * @param color é¢œè‰²
 545           */
 546          void OLED_DrawFilledTriangle(uint8_t x1, uint8_t y1, uint8_t x2, uint8_t y2, uint8_t x3, uint8_t y3, OLED_
             -ColorMode color)
 547          {
 548   1        uint8_t a = 0, b = 0, y = 0, last = 0;
 549   1        if (y1 > y2)
 550   1        {
 551   2          a = y2;
 552   2          b = y1;
 553   2        }
 554   1        else
 555   1        {
 556   2          a = y1;
 557   2          b = y2;
 558   2        }
 559   1        y = a;
 560   1        for (; y <= b; y++)
 561   1        {
 562   2          if (y <= y3)
 563   2          {
 564   3            OLED_DrawLine(x1 + (y - y1) * (x2 - x1) / (y2 - y1), y, x1 + (y - y1) * (x3 - x1) / (y3 - y1), y, co
             -lor);
 565   3          }
 566   2          else
 567   2          {
 568   3            last = y - 1;
 569   3            break;
 570   3          }
 571   2        }
 572   1        for (; y <= b; y++)
 573   1        {
 574   2          OLED_DrawLine(x2 + (y - y2) * (x3 - x2) / (y3 - y2), y, x1 + (y - last) * (x3 - x1) / (y3 - last), y, 
             -color);
 575   2        }
 576   1      }
 577          
 578          /**
 579           * @brief ç»˜åˆ¶ä¸€ä¸ªåœ†
 580           * @param x åœ†å¿ƒæ¨ªåæ ‡
 581           * @param y åœ†å¿ƒçºµåæ ‡
 582           * @param r åœ†åŠå¾„
 583           * @param color é¢œè‰²
 584           * @note æ­¤å‡½æ•°ä½¿ç”¨Bresenhamç®—æ³•ç»˜åˆ¶åœ†
 585           */
 586          void OLED_DrawCircle(uint8_t x, uint8_t y, uint8_t r, OLED_ColorMode color)
 587          {
 588   1        int16_t a = 0, b = r, di = 3 - (r << 1);
 589   1        while (a <= b)
 590   1        {
 591   2          OLED_SetPixel(x - b, y - a, color);
 592   2          OLED_SetPixel(x + b, y - a, color);
 593   2          OLED_SetPixel(x - a, y + b, color);
 594   2          OLED_SetPixel(x - b, y - a, color);
 595   2          OLED_SetPixel(x - a, y - b, color);
 596   2          OLED_SetPixel(x + b, y + a, color);
 597   2          OLED_SetPixel(x + a, y - b, color);
 598   2          OLED_SetPixel(x + a, y + b, color);
 599   2          OLED_SetPixel(x - b, y + a, color);
C51 COMPILER V9.60.7.0   OLED                                                              12/11/2023 21:20:52 PAGE 11  

 600   2          a++;
 601   2          if (di < 0)
 602   2          {
 603   3            di += 4 * a + 6;
 604   3          }
 605   2          else
 606   2          {
 607   3            di += 10 + 4 * (a - b);
 608   3            b--;
 609   3          }
 610   2          OLED_SetPixel(x + a, y + b, color);
 611   2        }
 612   1      }
 613          
 614          /**
 615           * @brief ç»˜åˆ¶ä¸€ä¸ªå¡«å……åœ†
 616           * @param x åœ†å¿ƒæ¨ªåæ ‡
 617           * @param y åœ†å¿ƒçºµåæ ‡
 618           * @param r åœ†åŠå¾„
 619           * @param color é¢œè‰²
 620           * @note æ­¤å‡½æ•°ä½¿ç”¨Bresenhamç®—æ³•ç»˜åˆ¶åœ†
 621           */
 622          void OLED_DrawFilledCircle(uint8_t x, uint8_t y, uint8_t r, OLED_ColorMode color)
 623          {
 624   1        int16_t a = 0, b = r, di = 3 - (r << 1);
 625   1        int16_t i;
 626   1        
 627   1        while (a <= b)
 628   1        {
 629   2          for (i = x - b; i <= x + b; i++)
 630   2          {
 631   3            OLED_SetPixel(i, y + a, color);
 632   3            OLED_SetPixel(i, y - a, color);
 633   3          }
 634   2          for (i = x - a; i <= x + a; i++)
 635   2          {
 636   3            OLED_SetPixel(i, y + b, color);
 637   3            OLED_SetPixel(i, y - b, color);
 638   3          }
 639   2          a++;
 640   2          if (di < 0)
 641   2          {
 642   3            di += 4 * a + 6;
 643   3          }
 644   2          else
 645   2          {
 646   3            di += 10 + 4 * (a - b);
 647   3            b--;
 648   3          }
 649   2        }
 650   1      }
 651          
 652          /**
 653           * @brief ç»˜åˆ¶ä¸€ä¸ªæ¤­åœ†
 654           * @param x æ¤­åœ†ä¸­å¿ƒæ¨ªåæ ‡
 655           * @param y æ¤­åœ†ä¸­å¿ƒçºµåæ ‡
 656           * @param a æ¤­åœ†é•¿è½´
 657           * @param b æ¤­åœ†çŸ­è½´
 658           */
 659          void OLED_DrawEllipse(uint8_t x, uint8_t y, uint8_t a, uint8_t b, OLED_ColorMode color)
 660          {
 661   1        int xpos = 0, ypos = b;
C51 COMPILER V9.60.7.0   OLED                                                              12/11/2023 21:20:52 PAGE 12  

 662   1        int a2 = a * a, b2 = b * b;
 663   1        int d = b2 + a2 * (0.25 - b);
 664   1        while (a2 * ypos > b2 * xpos)
 665   1        {
 666   2          OLED_SetPixel(x + xpos, y + ypos, color);
 667   2          OLED_SetPixel(x - xpos, y + ypos, color);
 668   2          OLED_SetPixel(x + xpos, y - ypos, color);
 669   2          OLED_SetPixel(x - xpos, y - ypos, color);
 670   2          if (d < 0)
 671   2          {
 672   3            d = d + b2 * ((xpos << 1) + 3);
 673   3            xpos += 1;
 674   3          }
 675   2          else
 676   2          {
 677   3            d = d + b2 * ((xpos << 1) + 3) + a2 * (-(ypos << 1) + 2);
 678   3            xpos += 1, ypos -= 1;
 679   3          }
 680   2        }
 681   1        d = b2 * (xpos + 0.5) * (xpos + 0.5) + a2 * (ypos - 1) * (ypos - 1) - a2 * b2;
 682   1        while (ypos > 0)
 683   1        {
 684   2          OLED_SetPixel(x + xpos, y + ypos, color);
 685   2          OLED_SetPixel(x - xpos, y + ypos, color);
 686   2          OLED_SetPixel(x + xpos, y - ypos, color);
 687   2          OLED_SetPixel(x - xpos, y - ypos, color);
 688   2          if (d < 0)
 689   2          {
 690   3            d = d + b2 * ((xpos << 1) + 2) + a2 * (-(ypos << 1) + 3);
 691   3            xpos += 1, ypos -= 1;
 692   3          }
 693   2          else
 694   2          {
 695   3            d = d + a2 * (-(ypos << 1) + 3);
 696   3            ypos -= 1;
 697   3          }
 698   2        }
 699   1      }
 700          
 701          /**
 702           * @brief ç»˜åˆ¶ä¸€å¼ å›¾ç‰‡
 703           * @param x èµ·å§‹ç‚¹æ¨ªåæ ‡
 704           * @param y èµ·å§‹ç‚¹çºµåæ ‡
 705           * @param img å›¾ç‰‡
 706           * @param color é¢œè‰²
 707           */
 708          void OLED_DrawImage(uint8_t x, uint8_t y, const struct Image *img, OLED_ColorMode color)
 709          {
 710   1        OLED_SetBlock(x, y, img->data_8, img->w, img->h, color);
 711   1      }
 712          
 713          // ================================ æ–‡å­—ç»˜åˆ¶ ================================
 714          
 715          /**
 716           * @brief ç»˜åˆ¶ä¸€ä¸ªASCIIå­—ç¬¦
 717           * @param x èµ·å§‹ç‚¹æ¨ªåæ ‡
 718           * @param y èµ·å§‹ç‚¹çºµåæ ‡
 719           * @param ch å­—ç¬¦
 720           * @param font å­—ä½“
 721           * @param color é¢œè‰²
 722           */
 723          void OLED_PrintASCIIChar(uint8_t x, uint8_t y, char ch, const struct ASCIIFont *font, OLED_ColorMode color
C51 COMPILER V9.60.7.0   OLED                                                              12/11/2023 21:20:52 PAGE 13  

             -)
 724          {
 725   1        OLED_SetBlock(x, y, font->chars + (ch - ' ') * (((font->h + 7) / 8) * font->w), font->w, font->h, color)
             -;
 726   1      }
 727          
 728          /**
 729           * @brief ç»˜åˆ¶ä¸€ä¸ªASCIIå­—ç¬¦ä¸²
 730           * @param x èµ·å§‹ç‚¹æ¨ªåæ ‡
 731           * @param y èµ·å§‹ç‚¹çºµåæ ‡
 732           * @param str å­—ç¬¦ä¸²
 733           * @param font å­—ä½“
 734           * @param color é¢œè‰²
 735           */
 736          void OLED_PrintASCIIString(uint8_t x, uint8_t y, char *str, const struct ASCIIFont *font, OLED_ColorMode c
             -olor)
 737          {
 738   1        uint8_t x0 = x;
 739   1        while (*str)
 740   1        {
 741   2          OLED_PrintASCIIChar(x0, y, *str, font, color);
 742   2          x0 += font->w;
 743   2          str++;
 744   2        }
 745   1      }
 746          
 747          /**
 748           * @brief è·å–UTF-8ç¼–ç çš„å­—ç¬¦é•¿åº¦
 749           */
 750          uint8_t _OLED_GetUTF8Len(char *string)
 751          {
 752   1        if ((string[0] & 0x80) == 0x00)
 753   1        {
 754   2          return 1;
 755   2        }
 756   1        else if ((string[0] & 0xE0) == 0xC0)
 757   1        {
 758   2          return 2;
 759   2        }
 760   1        else if ((string[0] & 0xF0) == 0xE0)
 761   1        {
 762   2          return 3;
 763   2        }
 764   1        else if ((string[0] & 0xF8) == 0xF0)
 765   1        {
 766   2          return 4;
 767   2        }
 768   1        return 0;
 769   1      }
 770          
 771          /**
 772           * @brief ç»˜åˆ¶å­—ç¬¦ä¸²
 773           * @param x èµ·å§‹ç‚¹æ¨ªåæ ‡
 774           * @param y èµ·å§‹ç‚¹çºµåæ ‡
 775           * @param str å­—ç¬¦ä¸²
 776           * @param font å­—ä½“
 777           * @param color é¢œè‰²
 778           *
 779           * @note ä¸ºä¿è¯å­—ç¬¦ä¸²ä¸­çš„ä¸­æ–‡ä¼šè¢«è‡ªåŠ¨è¯†åˆ«å¹¶ç»˜åˆ¶, éœ€:
 780           * 1. ç¼–è¯‘å™¨å­—ç¬¦é›†è®¾ç½®ä¸ºUTF-8
 781           * 2. ä½¿ç”¨æ³¢ç‰¹å¾‹åŠ¨LEDå–æ¨¡å·¥å…·ç”Ÿæˆå­—æ¨¡(https://led.baud-dance.com)
 782           */
C51 COMPILER V9.60.7.0   OLED                                                              12/11/2023 21:20:52 PAGE 14  

 783          /**
 784           * @brief ç»˜åˆ¶å­—ç¬¦ä¸²
 785           * @param x èµ·å§‹ç‚¹æ¨ªåæ ‡
 786           * @param y èµ·å§‹ç‚¹çºµåæ ‡
 787           * @param str å­—ç¬¦ä¸²
 788           * @param font å­—ä½“
 789           * @param color é¢œè‰²
 790           *
 791           * @note ä¸ºä¿è¯å­—ç¬¦ä¸²ä¸­çš„ä¸­æ–‡ä¼šè¢«è‡ªåŠ¨è¯†åˆ«å¹¶ç»˜åˆ¶, éœ€:
 792           * 1. ç¼–è¯‘å™¨å­—ç¬¦é›†è®¾ç½®ä¸ºUTF-8
 793           * 2. ä½¿ç”¨æ³¢ç‰¹å¾‹åŠ¨LEDå–æ¨¡å·¥å…·ç”Ÿæˆå­—æ¨¡(https://led.baud-dance.com)
 794           */
 795          void OLED_PrintString(uint8_t x, uint8_t y, char *str, const struct Font *font, OLED_ColorMode color)
 796          {
 797   1        uint16_t i = 0; // å­—ç¬¦ä¸²ç´¢å¼•
 798   1        uint8_t j;
 799   1        uint8_t oneLen = (((font->h + 7) / 8) * font->w) + 4; // ä¸€ä¸ªå­—æ¨¡å å¤šå°‘å­—èŠ‚
 800   1        uint8_t found;                                        // æ˜¯å¦æ‰¾åˆ°å­—æ¨¡
 801   1        uint8_t utf8Len;                                      // UTF-8ç¼–ç é•¿åº¦
 802   1        uint8_t *head;                                        // å­—æ¨¡å¤´æŒ‡é’ˆ
 803   1        while (str[i])
 804   1        {
 805   2          found = 0;
 806   2          utf8Len = _OLED_GetUTF8Len(str + i);
 807   2          if (utf8Len == 0)
 808   2            break; // æœ‰é—®é¢˜çš„UTF-8ç¼–ç 
 809   2      
 810   2          // å¯»æ‰¾å­—ç¬¦  TODO ä¼˜åŒ–æŸ¥æ‰¾ç®—æ³•, äºŒåˆ†æŸ¥æ‰¾æˆ–è€…hash
 811   2          for (j = 0; j < font->len; j++)
 812   2          {
 813   3            head = (uint8_t *)(font->chars) + (j * oneLen);
 814   3            if (memcmp(str + i, head, utf8Len) == 0)
 815   3            {
 816   4              OLED_SetBlock(x, y, head + 4, font->w, font->h, color);
 817   4              // ç§»åŠ¨å…‰æ ‡
 818   4              x += font->w;
 819   4              i += utf8Len;
 820   4              found = 1;
 821   4              break;
 822   4            }
 823   3          }
 824   2      
 825   2          // è‹¥æœªæ‰¾åˆ°å­—æ¨¡,ä¸”ä¸ºASCIIå­—ç¬¦, åˆ™ç¼ºçœæ˜¾ç¤ºASCIIå­—ç¬¦
 826   2          if (found == 0)
 827   2          {
 828   3            if (utf8Len == 1)
 829   3            {
 830   4              OLED_PrintASCIIChar(x, y, str[i], font->ascii, color);
 831   4              // ç§»åŠ¨å…‰æ ‡
 832   4              x += font->ascii->w;
 833   4              i += utf8Len;
 834   4            }
 835   3            else
 836   3            {
 837   4              OLED_PrintASCIIChar(x, y, ' ', font->ascii, color);
 838   4              x += font->ascii->w;
 839   4              i += utf8Len;
 840   4            }
 841   3          }
 842   2        }
 843   1      }

C51 COMPILER V9.60.7.0   OLED                                                              12/11/2023 21:20:52 PAGE 15  


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   5397    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   1157     162
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
