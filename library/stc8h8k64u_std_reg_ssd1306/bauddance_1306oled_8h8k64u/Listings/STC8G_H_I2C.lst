C51 COMPILER V9.60.7.0   STC8G_H_I2C                                                       12/11/2023 21:20:52 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE STC8G_H_I2C
OBJECT MODULE PLACED IN .\Objects\STC8G_H_I2C.obj
COMPILER INVOKED BY: D:\ProgramFiles\Keil_v5\C51\BIN\C51.EXE STC8G_H_I2C.c LARGE OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEX
                    -TEND PRINT(.\Listings\STC8G_H_I2C.lst) TABS(2) OBJECT(.\Objects\STC8G_H_I2C.obj)

line level    source

   1          /*---------------------------------------------------------------------*/
   2          /* --- STC MCU Limited ------------------------------------------------*/
   3          /* --- STC 1T Series MCU Demo Programme -------------------------------*/
   4          /* --- Mobile: (86)13922805190 ----------------------------------------*/
   5          /* --- Fax: 86-0513-55012956,55012947,55012969 ------------------------*/
   6          /* --- Tel: 86-0513-55012928,55012929,55012966 ------------------------*/
   7          /* --- Web: www.STCAI.com ---------------------------------------------*/
   8          /* --- BBS: www.STCAIMCU.com  -----------------------------------------*/
   9          /* --- QQ:  800003751 -------------------------------------------------*/
  10          /* å¦‚æœè¦åœ¨ç¨‹åºä¸­ä½¿ç”¨æ­¤ä»£ç ,è¯·åœ¨ç¨‹åºä¸­æ³¨æ˜ä½¿ç”¨äº†STCçš„èµ„æ–™åŠç¨‹åº            */
  11          /*---------------------------------------------------------------------*/
  12          /*
  13          *ä¸STCå®˜æ–¹åº“ç›¸æ¯”ï¼Œæ–°å¢
  14          *void I2C_WriteNbyte_WithoutmemaddrWrite(u8 dev_addr, u8 *p, u8 number)
  15          *ä¸
  16          *void I2C_ReadNbyte_WithoutmemaddrWrite(u8 dev_addr, u8 *p, u8 number)
  17          *å‡½æ•°
  18          *
  19          *2023/12/11 FQL
  20          */
  21          #include  "STC8G_H_I2C.h"
  22          
  23          u8 xdata I2C_Buffer[I2C_BUF_LENTH];
  24          
  25          //========================================================================
  26          // å‡½æ•°: void I2C_Init(I2C_InitTypeDef *I2Cx)
  27          // æè¿°: I2Cåˆå§‹åŒ–ç¨‹åº.
  28          // å‚æ•°: I2Cx: ç»“æ„å‚æ•°,è¯·å‚è€ƒI2C.hé‡Œçš„å®šä¹‰.
  29          // è¿”å›: none.
  30          // ç‰ˆæœ¬: V1.0, 2012-11-22
  31          //========================================================================
  32          void I2C_Init(I2C_InitTypeDef *I2Cx)
  33          {
  34   1        if(I2Cx->I2C_Mode == I2C_Mode_Master)
  35   1        {
  36   2          I2C_Master();     //è®¾ä¸ºä¸»æœº  
  37   2          I2CMSST = 0x00;   //æ¸…é™¤I2Cä¸»æœºçŠ¶æ€å¯„å­˜å™¨
  38   2          I2C_SetSpeed(I2Cx->I2C_Speed);
  39   2          if(I2Cx->I2C_MS_WDTA == ENABLE)   I2C_WDTA_EN();  //ä½¿èƒ½è‡ªåŠ¨å‘é€
  40   2          else                  I2C_WDTA_DIS(); //ç¦æ­¢è‡ªåŠ¨å‘é€
  41   2        }
  42   1        else
  43   1        {
  44   2          I2C_Slave();  //è®¾ä¸ºä»æœº
  45   2          I2CSLST = 0x00;   //æ¸…é™¤I2Cä»æœºçŠ¶æ€å¯„å­˜å™¨
  46   2          I2C_Address(I2Cx->I2C_SL_ADR);
  47   2          if(I2Cx->I2C_SL_MA == ENABLE)   I2C_MATCH_EN(); //ä»æœºåœ°å€æ¯”è¾ƒåŠŸèƒ½ï¼Œåªæ¥å—ç›¸åŒ¹é…åœ°å€
  48   2          else                  I2C_MATCH_DIS();  //ç¦æ­¢ä»æœºåœ°å€æ¯”è¾ƒåŠŸèƒ½ï¼Œæ¥å—æ‰€æœ‰è®¾å¤‡åœ°å€
  49   2        }
  50   1        
  51   1        I2C_Function(I2Cx->I2C_Enable);
  52   1      }
  53          
  54          //========================================================================
C51 COMPILER V9.60.7.0   STC8G_H_I2C                                                       12/11/2023 21:20:52 PAGE 2   

  55          // å‡½æ•°: u8 Get_MSBusy_Status (void)
  56          // æè¿°: è·å–ä¸»æœºå¿™ç¢ŒçŠ¶æ€.
  57          // å‚æ•°: none.
  58          // è¿”å›: ä¸»æœºå¿™ç¢ŒçŠ¶æ€.
  59          // ç‰ˆæœ¬: V1.0, 2012-11-22
  60          //========================================================================
  61          u8 Get_MSBusy_Status(void)
  62          {
  63   1        return (I2CMSST & 0x80);
  64   1      }
  65          
  66          //========================================================================
  67          // å‡½æ•°: void Wait (void)
  68          // æè¿°: ç­‰å¾…ä¸»æœºæ¨¡å¼I2Cæ§åˆ¶å™¨æ‰§è¡Œå®ŒæˆI2CMSCR.
  69          // å‚æ•°: none.
  70          // è¿”å›: none.
  71          // ç‰ˆæœ¬: V1.0, 2012-11-22
  72          //========================================================================
  73          void Wait()
  74          {
  75   1        while (!(I2CMSST & 0x40));
  76   1        I2CMSST &= ~0x40;
  77   1      }
  78          
  79          //========================================================================
  80          // å‡½æ•°: void Start (void)
  81          // æè¿°: I2Cæ€»çº¿èµ·å§‹å‡½æ•°.
  82          // å‚æ•°: none.
  83          // è¿”å›: none.
  84          // ç‰ˆæœ¬: V1.0, 2020-09-15
  85          //========================================================================
  86          void Start()
  87          {
  88   1        I2CMSCR = 0x01;                         //å‘é€STARTå‘½ä»¤
  89   1        Wait();
  90   1      }
  91          
  92          //========================================================================
  93          // å‡½æ•°: void SendData (char dat)
  94          // æè¿°: I2Cå‘é€ä¸€ä¸ªå­—èŠ‚æ•°æ®å‡½æ•°.
  95          // å‚æ•°: å‘é€çš„æ•°æ®.
  96          // è¿”å›: none.
  97          // ç‰ˆæœ¬: V1.0, 2020-09-15
  98          //========================================================================
  99          void SendData(char dat)
 100          {
 101   1        I2CTXD = dat;                           //å†™æ•°æ®åˆ°æ•°æ®ç¼“å†²åŒº
 102   1        I2CMSCR = 0x02;                         //å‘é€SENDå‘½ä»¤
 103   1        Wait();
 104   1      }
 105          
 106          //========================================================================
 107          // å‡½æ•°: void RecvACK (void)
 108          // æè¿°: I2Cè·å–ACKå‡½æ•°.
 109          // å‚æ•°: none.
 110          // è¿”å›: none.
 111          // ç‰ˆæœ¬: V1.0, 2020-09-15
 112          //========================================================================
 113          void RecvACK()
 114          {
 115   1        I2CMSCR = 0x03;                         //å‘é€è¯»ACKå‘½ä»¤
 116   1        Wait();
C51 COMPILER V9.60.7.0   STC8G_H_I2C                                                       12/11/2023 21:20:52 PAGE 3   

 117   1      }
 118          
 119          //========================================================================
 120          // å‡½æ•°: char RecvData (void)
 121          // æè¿°: I2Cè¯»å–ä¸€ä¸ªå­—èŠ‚æ•°æ®å‡½æ•°.
 122          // å‚æ•°: none.
 123          // è¿”å›: è¯»å–æ•°æ®.
 124          // ç‰ˆæœ¬: V1.0, 2020-09-15
 125          //========================================================================
 126          char RecvData()
 127          {
 128   1        I2CMSCR = 0x04;                         //å‘é€RECVå‘½ä»¤
 129   1        Wait();
 130   1        return I2CRXD;
 131   1      }
 132          
 133          //========================================================================
 134          // å‡½æ•°: void SendACK (void)
 135          // æè¿°: I2Cå‘é€ACKå‡½æ•°.
 136          // å‚æ•°: none.
 137          // è¿”å›: none.
 138          // ç‰ˆæœ¬: V1.0, 2020-09-15
 139          //========================================================================
 140          void SendACK()
 141          {
 142   1        I2CMSST = 0x00;                         //è®¾ç½®ACKä¿¡å·
 143   1        I2CMSCR = 0x05;                         //å‘é€ACKå‘½ä»¤
 144   1        Wait();
 145   1      }
 146          
 147          //========================================================================
 148          // å‡½æ•°: void SendNAK (void)
 149          // æè¿°: I2Cå‘é€NAKå‡½æ•°.
 150          // å‚æ•°: none.
 151          // è¿”å›: none.
 152          // ç‰ˆæœ¬: V1.0, 2020-09-15
 153          //========================================================================
 154          void SendNAK()
 155          {
 156   1        I2CMSST = 0x01;                         //è®¾ç½®NAKä¿¡å·
 157   1        I2CMSCR = 0x05;                         //å‘é€ACKå‘½ä»¤
 158   1        Wait();
 159   1      }
 160          
 161          //========================================================================
 162          // å‡½æ•°: void Stop (void)
 163          // æè¿°: I2Cæ€»çº¿åœæ­¢å‡½æ•°.
 164          // å‚æ•°: none.
 165          // è¿”å›: none.
 166          // ç‰ˆæœ¬: V1.0, 2020-09-15
 167          //========================================================================
 168          void Stop()
 169          {
 170   1        I2CMSCR = 0x06;                         //å‘é€STOPå‘½ä»¤
 171   1        Wait();
 172   1      }
 173          
 174          //========================================================================
 175          // å‡½æ•°: void SendCmdData (u8 cmd, u8 dat)
 176          // æè¿°: I2Cå‘é€ä¸€ä¸ªå­—èŠ‚æ•°æ®å‡½æ•°.
 177          // å‚æ•°: å‘½ä»¤/æ•°æ®.
 178          // è¿”å›: none.
C51 COMPILER V9.60.7.0   STC8G_H_I2C                                                       12/11/2023 21:20:52 PAGE 4   

 179          // ç‰ˆæœ¬: V1.0, 2020-09-15
 180          //========================================================================
 181          void SendCmdData(u8 cmd, u8 dat)
 182          {
 183   1        I2CTXD = dat;                           //å†™æ•°æ®åˆ°æ•°æ®ç¼“å†²åŒº
 184   1        I2CMSCR = cmd;                          //è®¾ç½®å‘½ä»¤
 185   1        Wait();
 186   1      }
 187          
 188          //========================================================================
 189          // å‡½æ•°: void I2C_WriteNbyte(u8 dev_addr, u8 mem_addr, u8 *p, u8 number)
 190          // æè¿°: I2Cå†™å…¥æ•°æ®å‡½æ•°.
 191          // å‚æ•°: dev_addr: è®¾å¤‡åœ°å€, mem_addr: å­˜å‚¨åœ°å€, *på†™å…¥æ•°æ®å­˜å‚¨ä½ç½®, numberå†™å…¥æ•°æ®ä
             -¸ªæ•°.
 192          // è¿”å›: none.
 193          // ç‰ˆæœ¬: V1.0, 2020-09-15
 194          //========================================================================
 195          void I2C_WriteNbyte(u8 dev_addr, u8 mem_addr, u8 *p, u8 number)  /*  DeviceAddress,WordAddress,First Data 
             -Address,Byte lenth   */
 196          {
 197   1        Start();                                //å‘é€èµ·å§‹å‘½ä»¤
 198   1        SendData(dev_addr);                     //å‘é€è®¾å¤‡åœ°å€+å†™å‘½ä»¤
 199   1        RecvACK();
 200   1        SendData(mem_addr);                     //å‘é€å­˜å‚¨åœ°å€
 201   1        RecvACK();
 202   1        do
 203   1        {
 204   2          SendData(*p++);
 205   2          RecvACK();
 206   2        }
 207   1        while(--number);
 208   1        Stop();                                 //å‘é€åœæ­¢å‘½ä»¤
 209   1      }
 210          
 211          void I2C_WriteNbyte_WithoutmemaddrWrite(u8 dev_addr, u8 *p, u8 number)  /*  DeviceAddress,WordAddress,Firs
             -t Data Address,Byte lenth   */
 212          {
 213   1        Start();                                //å‘é€èµ·å§‹å‘½ä»¤
 214   1        SendData(dev_addr);                     //å‘é€è®¾å¤‡åœ°å€+å†™å‘½ä»¤
 215   1        RecvACK();
 216   1      //  SendData(mem_addr);                     //å‘é€å­˜å‚¨åœ°å€
 217   1      //  RecvACK();
 218   1        do
 219   1        {
 220   2          SendData(*p++);
 221   2          RecvACK();
 222   2        }
 223   1        while(--number);
 224   1        Stop();                                 //å‘é€åœæ­¢å‘½ä»¤
 225   1      }
 226          
 227          //========================================================================
 228          // å‡½æ•°: void I2C_ReadNbyte(u8 dev_addr, u8 mem_addr, u8 *p, u8 number)
 229          // æè¿°: I2Cè¯»å–æ•°æ®å‡½æ•°.
 230          // å‚æ•°: dev_addr: è®¾å¤‡åœ°å€, mem_addr: å­˜å‚¨åœ°å€, *pè¯»å–æ•°æ®å­˜å‚¨ä½ç½®, numberè¯»å–æ•°æ®ä
             -¸ªæ•°.
 231          // è¿”å›: none.
 232          // ç‰ˆæœ¬: V1.0, 2020-09-15
 233          //========================================================================
 234          void I2C_ReadNbyte(u8 dev_addr, u8 mem_addr, u8 *p, u8 number)   /*  DeviceAddress,WordAddress,First Data 
             -Address,Byte lenth   */
 235          {
C51 COMPILER V9.60.7.0   STC8G_H_I2C                                                       12/11/2023 21:20:52 PAGE 5   

 236   1        Start();                                //å‘é€èµ·å§‹å‘½ä»¤
 237   1        SendData(dev_addr);                     //å‘é€è®¾å¤‡åœ°å€+å†™å‘½ä»¤
 238   1        RecvACK();
 239   1        SendData(mem_addr);                     //å‘é€å­˜å‚¨åœ°å€
 240   1        RecvACK();
 241   1        Start();                                //å‘é€èµ·å§‹å‘½ä»¤
 242   1        SendData(dev_addr|1);                   //å‘é€è®¾å¤‡åœ°å€+è¯»å‘½ä»¤
 243   1        RecvACK();
 244   1        do
 245   1        {
 246   2          *p = RecvData();
 247   2          p++;
 248   2          if(number != 1) SendACK();          //send ACK
 249   2        }
 250   1        while(--number);
 251   1        SendNAK();                              //send no ACK 
 252   1        Stop();                                 //å‘é€åœæ­¢å‘½ä»¤
 253   1      }
 254          
 255          void I2C_ReadNbyte_WithoutmemaddrWrite(u8 dev_addr, u8 *p, u8 number)   /*  DeviceAddress,First Data Addre
             -ss,Byte lenth   */
 256          {
 257   1      //  Start();                                //å‘é€èµ·å§‹å‘½ä»¤
 258   1      //  SendData(dev_addr);                     //å‘é€è®¾å¤‡åœ°å€+å†™å‘½ä»¤
 259   1      //  RecvACK();
 260   1      //  SendData(mem_addr);                     //å‘é€å­˜å‚¨åœ°å€
 261   1      //  RecvACK();
 262   1        Start();                                //å‘é€èµ·å§‹å‘½ä»¤
 263   1        SendData(dev_addr|1);                   //å‘é€è®¾å¤‡åœ°å€+è¯»å‘½ä»¤
 264   1        RecvACK();
 265   1        do
 266   1        {
 267   2          *p = RecvData();
 268   2          p++;
 269   2          if(number != 1) SendACK();          //send ACK
 270   2        }
 271   1        while(--number);
 272   1        SendNAK();                              //send no ACK 
 273   1        Stop();                                 //å‘é€åœæ­¢å‘½ä»¤
 274   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    448    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =      8      22
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
